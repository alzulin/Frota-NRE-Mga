<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Últimas Chegadas</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <h1 class="text-2xl font-bold mb-4">Última Chegada de Cada Veículo</h1>

  <table class="w-full border bg-white shadow rounded">
    <thead>
      <tr class="bg-gray-200 text-left">
        <th class="p-2 border">Veículo</th>
        <th class="p-2 border">Data</th>
        <th class="p-2 border">Hora</th>
        <th class="p-2 border">Combustível</th>
      </tr>
    </thead>
    <tbody id="tabelaChegadas"></tbody>
  </table>

  <a href="index.html" class="block mt-4 text-blue-600">Voltar</a>

  <script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyXQchF46LjL-Dt7uyoMi5b7RlDpy-zm1VToIyb2TAdfFyeOEzJuHYkS8VjCkXQp0My8Q/exec";

    function fmtDate(val) {
      if (val === null || val === undefined || val === "") return "-";
      if (typeof val === "number") {
        const ms = Math.round((val - 25569) * 86400 * 1000);
        return new Date(ms).toDateString().slice(4);
      }
      if (/^\d{4}-\d{2}-\d{2}$/.test(val)) {
        return new Date(val + "T00:00:00").toDateString().slice(4);
      }
      const d = new Date(val);
      if (!isNaN(d)) return d.toDateString().slice(4);
      const m = String(val).match(/[A-Z][a-z]{2}\s+\d{1,2}\s+\d{4}/);
      return m ? m[0] : String(val);
    }

    function fmtTime(val) {
      if (val === null || val === undefined || val === "") return "-";
      if (typeof val === "number") {
        const totalMin = Math.round(val * 24 * 60);
        const h = String(Math.floor(totalMin / 60) % 24).padStart(2, "0");
        const m = String(totalMin % 60).padStart(2, "0");
        return `${h}:${m}`;
      }
      const mm = String(val).match(/(\d{1,2}):(\d{2})/);
      if (mm) return `${mm[1].padStart(2,"0")}:${mm[2]}`;
      const d = new Date(val);
      if (!isNaN(d)) {
        const h = String(d.getHours()).padStart(2,"0");
        const m = String(d.getMinutes()).padStart(2,"0");
        return `${h}:${m}`;
      }
      return String(val);
    }

    async function carregarUltimasChegadas() {
      try {
        const base = `${URL_SCRIPT}?tipo=ultimasChegadas`;
const sep  = base.includes("?") ? "&" : "?";
const url  = `${base}${sep}t=${Date.now()}`; // parâmetro único a cada chamada

const resp = await fetch(url, { cache: "no-store" });

        if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
        const dados = await resp.json();

        const tbody = document.getElementById("tabelaChegadas");
        tbody.innerHTML = "";

        dados.forEach(reg => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="p-2 border">${reg.veiculo}</td>
            <td class="p-2 border">${fmtDate(reg.data)}</td>
            <td class="p-2 border">${fmtTime(reg.hora)}</td>
            <td class="p-2 border">${reg.combustivel || "-"}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        alert("Erro ao carregar últimas chegadas.");
        console.error(e);
      }
    }

    carregarUltimasChegadas();
  </script>
</body>
</html>
