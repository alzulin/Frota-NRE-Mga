<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registrar Abastecimento</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">Registrar Abastecimento</h1>

    <form id="abastecimentoForm" class="space-y-3">
      <select id="abastecimentoVeiculo" class="w-full border p-2 rounded" required></select>

      <div class="grid grid-cols-2 gap-3">
        <input type="date" id="abastecimentoData" class="w-full border p-2 rounded" required />
        <input type="time" id="abastecimentoHora" class="w-full border p-2 rounded" required />
      </div>

      <input type="number" step="0.01" id="abastecimentoLitros" placeholder="Litros abastecidos" class="w-full border p-2 rounded" required />

      <div class="space-y-2">
        <input type="file" id="abastecimentoFoto" accept="image/*" capture="environment" class="w-full border p-2 rounded" required />
        <img id="previewFoto" class="hidden w-40 h-auto rounded shadow" alt="Pr√©via da foto" />
      </div>

      <input type="text" id="abastecimentoTecnico" placeholder="T√©cnico respons√°vel" class="w-full border p-2 rounded" required />

      <button type="submit" id="btnEnviar" class="bg-yellow-600 text-white px-4 py-2 rounded w-full disabled:opacity-50" disabled>
        Registrar Abastecimento
      </button>
    </form>

    <a href="index.html" class="block mt-4 text-blue-600">Voltar</a>
  </div>

  <script>
    // üîó Cole aqui a URL /exec do seu Web App (deploy ATUAL)
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbxsD-nLh5hL1iuH03sq8KH7nTmCJvB7kIYvRKbod1vW8NiNtM90bwujptT5asSNJgyY6g/exec";

    // Lista de ve√≠culos
    const veiculos = [
      "CRONOS ‚Äì SES4A21","CRONOS ‚Äì SES4A66","CRONOS ‚Äì TO3D38","DUSTER ‚Äì BDR4E41",
      "PARATI ‚Äì AVA5383","PARATI ‚Äì AVA6129","PARATI ‚Äì AVB2284","VOYAGE ‚Äì BCR3J12"
    ];

    // Elementos
    const selVeiculo = document.getElementById('abastecimentoVeiculo');
    const fileInput  = document.getElementById('abastecimentoFoto');
    const preview    = document.getElementById('previewFoto');
    const btnEnviar  = document.getElementById('btnEnviar');
    const form       = document.getElementById('abastecimentoForm');

    // Estado da foto (fallback base64)
    let fotoBase64 = "", fotoTipo = "", fotoNome = "";

    // Popular ve√≠culos
    (function popularVeiculos() {
      veiculos.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        selVeiculo.appendChild(opt);
      });
    })();

    // Pr√©-visualiza√ß√£o e captura de base64 (fallback)
    fileInput.addEventListener('change', () => {
      const arq = fileInput.files[0];
      if (!arq) {
        btnEnviar.disabled = true;
        preview.classList.add('hidden');
        preview.removeAttribute('src');
        fotoBase64 = fotoTipo = fotoNome = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = e => {
        const dataUrl = e.target.result;
        // Pr√©via
        preview.src = dataUrl;
        preview.classList.remove('hidden');
        // Fallback base64
        fotoBase64 = dataUrl.split(',')[1];
        fotoTipo   = arq.type || "image/jpeg";
        fotoNome   = arq.name || "comprovante.jpg";
        // Habilita envio
        btnEnviar.disabled = false;
      };
      reader.onerror = () => {
        alert("Erro ao carregar a foto.");
        btnEnviar.disabled = true;
      };
      reader.readAsDataURL(arq);
    });

    // Envio
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const foto = fileInput.files[0];
      if (!foto) return alert("Selecione a foto do comprovante.");

      // Monta FormData sem headers customizados (evita preflight CORS)
      const fd = new FormData();
      fd.append('tipo', 'Abastecimento');
      fd.append('veiculo', selVeiculo.value);
      fd.append('data', document.getElementById('abastecimentoData').value);
      fd.append('hora', document.getElementById('abastecimentoHora').value);
      fd.append('litros', document.getElementById('abastecimentoLitros').value);
      fd.append('tecnico', document.getElementById('abastecimentoTecnico').value);

      // Foto como arquivo + fallback base64
      fd.append('foto', foto, foto.name);
      fd.append('fotoBase64', fotoBase64);
      fd.append('fotoTipo',   fotoTipo);
      fd.append('fotoNome',   fotoNome);

      // UX
      btnEnviar.disabled = true;
      const oldLabel = btnEnviar.textContent;
      btnEnviar.textContent = "Enviando...";

      try {
        const resp = await fetch(URL_SCRIPT, { method: "POST", body: fd });
        if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);

        // Tenta JSON; se n√£o for JSON, cai pra texto
        let dados;
        try { dados = await resp.json(); }
        catch { dados = { status: "desconhecido", bruto: await resp.text() }; }

        if (dados.status === "sucesso") {
          alert("‚úÖ Abastecimento registrado!");
          form.reset();
          preview.classList.add('hidden');
          preview.removeAttribute('src');
          fotoBase64 = fotoTipo = fotoNome = "";
        } else {
          alert("‚ö†Ô∏è Erro: " + (dados.mensagem || JSON.stringify(dados)));
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Erro na conex√£o: " + err.message);
      } finally {
        btnEnviar.disabled = false;
        btnEnviar.textContent = oldLabel;
      }
    });
  </script>
</body>
</html>






