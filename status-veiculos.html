<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Status dos Ve√≠culos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-5xl mx-auto space-y-4">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Status dos Ve√≠culos</h1>
      <a href="index.html" class="text-blue-600 hover:underline">Voltar</a>
    </header>

    <section class="bg-white rounded-lg shadow p-4">
      <div class="grid gap-3 md:grid-cols-3">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Filtrar ve√≠culo</label>
          <select id="filtroVeiculo" class="w-full border p-2 rounded">
            <option value="">Todos os ve√≠culos</option>
          </select>
        </div>
        <div class="flex items-end gap-3">
          <button id="btnAtualizar" class="bg-yellow-600 text-white px-4 py-2 rounded">Atualizar</button>
          <span id="infoAtualizado" class="text-sm text-gray-500"></span>
        </div>
      </div>
    </section>

    <section id="cards" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></section>
  </div>

  <script>
    // üîó URL /exec do seu Web App
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbylm9XPBh_AGIl9Q5E73P54MSCFsUFlmeDfx6Jw1Ymmr54bFTv3K6vq23-ZDAj0eBH0hw/exec";

    const VEICULOS = [
      "CRONOS ‚Äì SES4A21","CRONOS ‚Äì SES4A66","CRONOS ‚Äì TO3D38","DUSTER ‚Äì BDR4E41",
      "PARATI ‚Äì AVA5383","PARATI ‚Äì AVA6129","PARATI ‚Äì AVB2284","VOYAGE ‚Äì BCR3J12"
    ];

    const filtroVeiculo = document.getElementById('filtroVeiculo');
    const btnAtualizar  = document.getElementById('btnAtualizar');
    const infoAtualizado= document.getElementById('infoAtualizado');
    const cards         = document.getElementById('cards');

    // Preenche o filtro
    VEICULOS.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v; opt.textContent = v;
      filtroVeiculo.appendChild(opt);
    });

    // -------------------------
    // Helpers de formata√ß√£o
    // -------------------------
    function fmtDate(val) {
      if (val === null || val === undefined || val === "") return "-";
      // n√∫mero (serial do Sheets)?
      if (typeof val === "number") {
        const ms = Math.round((val - 25569) * 86400 * 1000); // Excel‚ÜíJS
        const d  = new Date(ms);
        return d.toDateString().slice(4); // "Aug 21 2025"
      }
      // ISO "YYYY-MM-DD"
      if (/^\d{4}-\d{2}-\d{2}$/.test(val)) {
        const d = new Date(val + "T00:00:00");
        return d.toDateString().slice(4);
      }
      // Date parse√°vel
      const d = new Date(val);
      if (!isNaN(d)) return d.toDateString().slice(4);
      // fallback: tenta extrair "Mon DD YYYY"
      const m = String(val).match(/[A-Z][a-z]{2}\s+\d{1,2}\s+\d{4}/);
      return m ? m[0] : String(val);
    }

    function fmtTime(val) {
      if (val === null || val === undefined || val === "") return "-";
      // n√∫mero (fra√ß√£o do dia)
      if (typeof val === "number") {
        const totalMin = Math.round(val * 24 * 60);
        const h = String(Math.floor(totalMin / 60) % 24).padStart(2, "0");
        const m = String(totalMin % 60).padStart(2, "0");
        return `${h}:${m}`;
      }
      // "HH:MM" j√° v√°lido
      const mm = String(val).match(/(\d{1,2}):(\d{2})/);
      if (mm) return `${mm[1].padStart(2,"0")}:${mm[2]}`;
      // Date parse√°vel
      const d = new Date(val);
      if (!isNaN(d)) {
        const h = String(d.getHours()).padStart(2,"0");
        const m = String(d.getMinutes()).padStart(2,"0");
        return `${h}:${m}`;
      }
      return String(val);
    }

    function badgeDisponibilidade(emUso) {
      const cor = emUso ? "bg-red-100 text-red-700" : "bg-green-100 text-green-700";
      const txt = emUso ? "Em uso" : "Dispon√≠vel";
      return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${cor}">${txt}</span>`;
    }

    function linha(label, valor) {
      return `<div class="flex justify-between text-sm"><span class="text-gray-600">${label}</span><span class="font-medium">${valor || "-"}</span></div>`;
    }

    function cardVeiculo(v) {
      const uc  = v.ultimaChegada;
      const us  = v.ultimaSaida;

      const chegada = uc ? `${fmtDate(uc.data)} ${fmtTime(uc.hora)}` : "-";
      const saida   = us ? `${fmtDate(us.data)} ${fmtTime(us.hora)}` : "-";
      const combustivel = uc && uc.combustivel ? uc.combustivel : "-";

      return `
        <div class="bg-white rounded-lg shadow p-4 flex flex-col gap-2">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">${v.veiculo}</h3>
            ${badgeDisponibilidade(v.emUso)}
          </div>
          <div class="space-y-1">
            ${linha("√öltima Chegada", chegada)}
            ${linha("Combust√≠vel (na chegada)", combustivel)}
            ${linha("√öltima Sa√≠da", saida)}
          </div>
        </div>
      `;
    }

    async function carregar() {
      try {
        btnAtualizar.disabled = true;
        btnAtualizar.textContent = "Atualizando...";
        cards.innerHTML = "";

        const veic = filtroVeiculo.value;
const base = veic
  ? `${URL_SCRIPT}?action=status&veiculo=${encodeURIComponent(veic)}`
  : `${URL_SCRIPT}?action=status`;

// ‚ö†Ô∏è Evita respostas ‚Äúantigas‚Äù do cache
const url = `${base}&t=${Date.now()}`;

const resp = await fetch(url, { cache: "no-store" });
     
        if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
        const dados = await resp.json();

        infoAtualizado.textContent = `Atualizado em ${new Date(dados.updatedAt).toLocaleString()}`;

        const lista = dados.vehicles || [];
        cards.innerHTML = lista.map(cardVeiculo).join("") || `<p class="text-gray-600">Nenhum ve√≠culo encontrado.</p>`;
      } catch (err) {
        console.error(err);
        alert("Erro ao carregar status: " + err.message);
      } finally {
        btnAtualizar.disabled = false;
        btnAtualizar.textContent = "Atualizar";
      }
    }

    btnAtualizar.addEventListener('click', carregar);
    filtroVeiculo.addEventListener('change', carregar);
    carregar();
  </script>
</body>
</html>
